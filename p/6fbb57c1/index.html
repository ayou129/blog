<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Lua · 阿尤</title><meta name="description" content="Lua - 阿尤"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/blog/index.ico"><link rel="stylesheet" href="/blog/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://ayou129.github.io/blog/atom.xml" title="阿尤"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="阿尤" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/blog/" class="logo-link"><img src="/blog/index.ico" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/blog/" target="_self" class="nav-list-link">首页</a></li><li class="nav-list-item"><a href="/blog/tags" target="_self" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="/blog/categories" target="_self" class="nav-list-link">分类</a></li><li class="nav-list-item"><a href="/blog/archives/" target="_self" class="nav-list-link">历史文章</a></li><li class="nav-list-item"><a href="/blog/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><!--mixin postList()--><!--    .archive--><!--        - var year = 0;--><!--        - var change = false;--><!--        - page.posts.each(function (item) {--><!--            - var itemYear = date(item.date, 'YYYY') - 0;--><!--            - change = year !== itemYear;--><!--            - year = change ? itemYear : year;--><!--            if change--><!--                h2.archive-year!= year--><!--            .post-item--><!--                +postInfo(item)--><!--                a.post-title-link(href= url_for(item.path))--><!--                    != item.title--><!--        - })--><div class="post"><article class="post-block"><h1 class="post-title">Lua</h1><div class="post-info">创建于：2022年12月9日<span style="margin-left: 0.5rem"></span>上次更新：2022年10月23日</div><div class="post-content"><p>学习一下lua语言，使用到的场景有许多，游戏开发、redis中并发问题。</p>
<span id="more"></span>
<h2 id="有关游戏的"><a href="#有关游戏的" class="headerlink" title="有关游戏的"></a>有关游戏的</h2><p>在编写<code>第三人称游戏</code>的开发核心代码时，我们可以考虑以下几个方面：</p>
<ul>
<li>使用<code>变量</code>来存储<code>玩家的位置和姿势</code>，并根据键盘或控制器的输入来更新玩家的位置。</li>
<li>使用<code>函数</code>来封装<code>游戏世界中的各种对象</code>，例如：敌人、道具、建筑物等。</li>
<li>使用<code>循环</code>来处理<code>游戏世界中各个对象的逻辑</code>，例如：敌人的移动、道具的消失、建筑物的损坏等。</li>
<li>使用<code>条件语句</code>来处理游戏<code>世界中各种事件的发生</code>，例如：玩家的死亡、敌人的攻击、道具的收集等。</li>
</ul>
<p>以下是一段基本的第三人称游戏开发核心代码的例子：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 定义玩家的位置和姿势变量</span></span><br><span class="line"><span class="keyword">local</span> playerPosition = &#123;x = <span class="number">0</span>, y = <span class="number">0</span>, z = <span class="number">0</span>&#125;</span><br><span class="line"><span class="keyword">local</span> playerRotation = &#123;x = <span class="number">0</span>, y = <span class="number">0</span>, z = <span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 定义游戏世界中各种对象的函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createEnemy</span><span class="params">(position, rotation)</span></span></span><br><span class="line"><span class="keyword">local</span> enemy = &#123;</span><br><span class="line">    position = position,</span><br><span class="line">    rotation = rotation,</span><br><span class="line">    health = <span class="number">100</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> enemy</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createItem</span><span class="params">(position, rotation)</span></span></span><br><span class="line"><span class="keyword">local</span> item = &#123;</span><br><span class="line">    position = position,</span><br><span class="line">    rotation = rotation,</span><br><span class="line">    duration = <span class="number">10</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> item</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createBuilding</span><span class="params">(position, rotation)</span></span></span><br><span class="line"><span class="keyword">local</span> building = &#123;</span><br><span class="line">    position = position,</span><br><span class="line">    rotation = rotation,</span><br><span class="line">    health = <span class="number">1000</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> building</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 初始化游戏世界中的各种对象</span></span><br><span class="line"><span class="keyword">local</span> enemies = &#123;&#125;</span><br><span class="line"><span class="keyword">local</span> items = &#123;&#125;</span><br><span class="line"><span class="keyword">local</span> buildings = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 处理游戏世界中各个对象</span></span><br></pre></td></tr></table></figure>

<h3 id="计算炮弹的轨迹"><a href="#计算炮弹的轨迹" class="headerlink" title="计算炮弹的轨迹"></a>计算炮弹的轨迹</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 炮弹的初始位置</span></span><br><span class="line"><span class="keyword">local</span> bullet_x = <span class="number">10</span></span><br><span class="line"><span class="keyword">local</span> bullet_y = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 炮弹的初始速度和方向</span></span><br><span class="line"><span class="keyword">local</span> bullet_speed = <span class="number">100</span></span><br><span class="line"><span class="keyword">local</span> bullet_angle = <span class="number">45</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 炮弹的重力加速度</span></span><br><span class="line"><span class="keyword">local</span> gravity = <span class="number">9.8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 计算炮弹的位移</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">time</span> = <span class="number">0.1</span></span><br><span class="line">bullet_x = bullet_x + bullet_speed * <span class="built_in">math</span>.<span class="built_in">cos</span>(bullet_angle) * <span class="built_in">time</span></span><br><span class="line">bullet_y = bullet_y + bullet_speed * <span class="built_in">math</span>.<span class="built_in">sin</span>(bullet_angle) * <span class="built_in">time</span> - <span class="number">0.5</span> * gravity * <span class="built_in">time</span> * <span class="built_in">time</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输出炮弹的新位置</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;bullet_x = &quot;</span> .. bullet_x)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;bullet_y = &quot;</span> .. bullet_y)</span><br></pre></td></tr></table></figure>

<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><blockquote>
<p><a href="http://www.lua.org/start.html" target="_blank" rel="noopener">http://www.lua.org/start.html</a></p>
</blockquote>
<h3 id="MAC源代码编译"><a href="#MAC源代码编译" class="headerlink" title="MAC源代码编译"></a>MAC源代码编译</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl -R -O http://www.lua.org/ftp/lua-<span class="number">5</span>.<span class="number">4</span>.<span class="number">4</span>.tar.gz</span><br><span class="line">tar zxf lua-<span class="number">5</span>.<span class="number">4</span>.<span class="number">4</span>.tar.gz</span><br><span class="line"><span class="built_in">cd</span> lua-<span class="number">5</span>.<span class="number">4</span>.<span class="number">4</span></span><br><span class="line">make all test</span><br><span class="line"></span><br><span class="line"># 出现这个说明成功</span><br><span class="line">lua -v</span><br><span class="line">Lua <span class="number">5</span>.<span class="number">4</span>.<span class="number">4</span>  Copyright (C) <span class="number">1994</span>-<span class="number">2022</span> Lua.org, PUC-Rio</span><br><span class="line"></span><br><span class="line"># 安装</span><br><span class="line">sudo make all install</span><br><span class="line"></span><br><span class="line">lua -v</span><br></pre></td></tr></table></figure>

<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><ol>
<li><a href="https://www.lua.org/download.html" target="_blank" rel="noopener">https://www.lua.org/download.html</a> 选择 <code>Building</code> -&gt; <code>get a binary</code></li>
<li>Download</li>
<li>lua-5.4.2_Win64_bin.zip</li>
<li>Windows 高级系统设置 环境变量 系统变量 Path + <code>C:\Users\lee\lua-5.4.2_Win64_bin</code><figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lua54 -v</span><br><span class="line"><span class="meta">&gt;</span> <span class="language-javascript"><span class="title class_">Lua</span> <span class="number">5.4</span><span class="number">.2</span>  <span class="title class_">Copyright</span> (C) <span class="number">1994</span>-<span class="number">2020</span> <span class="title class_">Lua</span>.<span class="property">org</span>, <span class="variable constant_">PUC</span>-<span class="title class_">Rio</span></span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h2><p>注释</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 单行注释</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment">    多行注释</span></span><br><span class="line"><span class="comment">]]</span></span><br></pre></td></tr></table></figure>

<p>类型和值</p>
<blockquote>
<p>使用 type 可以获取 <code>值</code> 对应的类型名称(return string)</p>
</blockquote>
<p>8中基本类型</p>
<ul>
<li>nil(空，主要作用是和其他值进行区分，初始化的时候会被回收内存)</li>
<li>boolean</li>
<li>number</li>
<li>string</li>
<li>userdata(用户数据，例如，标准I&#x2F;O库使用用户数据来表示打开的文件)</li>
<li>function(函数)</li>
<li>thread(线程)</li>
<li>table(表)</li>
</ul>
<p>数值常量<br>整型 和 浮点型 都是”number”，可以相互转换，也相等</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="number">1</span> == <span class="number">1.0</span> <span class="comment">--&gt; true</span></span><br><span class="line">&gt; <span class="number">-3</span> == <span class="number">-3.0</span> <span class="comment">--&gt; true</span></span><br><span class="line">&gt; <span class="number">0.2e3</span> == <span class="number">200</span> <span class="comment">--&gt; true</span></span><br></pre></td></tr></table></figure>
<p>如果要区分整型 和 浮点型，则使用<code>math.type</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">math</span>.<span class="built_in">type</span>(<span class="number">3</span>)  <span class="comment">--&gt; integer</span></span><br><span class="line"><span class="built_in">math</span>.<span class="built_in">type</span>(<span class="number">3.0</span>) <span class="comment">--&gt; float</span></span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 幂运算 ^ <span class="keyword">return</span> float</span><br><span class="line">x^<span class="number">0.5</span> 计算x的平方根</span><br><span class="line">x^(<span class="number">1</span>/<span class="number">3</span>) 计算x的立方根</span><br></pre></td></tr></table></figure>

<p>关系运算</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">== 相等性测试</span><br><span class="line">~= 不等性测试</span><br><span class="line">&lt;=</span><br><span class="line">&gt;=</span><br><span class="line">&gt;</span><br><span class="line">&lt;</span><br></pre></td></tr></table></figure>
<p>数学库(math)<br>数学函数、<br>指数函数、<br>取整函数</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">floor</span> 向负无穷取整</span><br><span class="line"><span class="built_in">ceil</span> 向正无穷取整</span><br><span class="line"><span class="built_in">modf</span> 向零取整，额外返回小数部分</span><br></pre></td></tr></table></figure>
<p>最大和最小函数maxmin、<br>随机数random</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">random</span>() 不带参数[<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line"><span class="built_in">random</span>() 带<span class="number">1</span>参数：整型，[<span class="number">1</span>,n]</span><br><span class="line"><span class="built_in">random</span>() 带<span class="number">2</span>参数：整型，[n,y]</span><br><span class="line">例子：<span class="built_in">random</span>(<span class="number">6</span>) 模拟筛子</span><br><span class="line"></span><br><span class="line"><span class="built_in">randomseed</span> 设置伪随机数发生器的种子，，通常调用<span class="built_in">math</span>.<span class="built_in">randomseed</span>(<span class="built_in">os</span>.<span class="built_in">time</span>())来使用当前系统时间作为种子初始化随机数发生器</span><br></pre></td></tr></table></figure>
<p>πpi、<br>huge(最大可表示数值，大多数平台代表inf)</p>
<p>表示范围</p>
<table>
<thead>
<tr>
<th>版本</th>
<th>整型存储</th>
<th>浮点型存储</th>
</tr>
</thead>
<tbody><tr>
<td>标准Lua</td>
<td>64个比特位 最大值是2^63-1</td>
<td>双精度，64个比特位，11位为指数；16个有效十进制位</td>
</tr>
<tr>
<td>精简Lua</td>
<td>32个比特位 最大值是2^31-1</td>
<td>单精度，32个比特位；7个有效十进制位</td>
</tr>
</tbody></table>
<p>双精度浮点数的限制：</p>
<ul>
<li>回环</li>
<li>超过表示范围之后不可控，会导致精度缺失，要谨慎思考所使用的表示方式</li>
</ul>
<p>强制转换<br>对于整型 可以使用 + 0.0 强制转换成浮点型</p>
<p>但是如果精度缺失后，可以使用 与零进行按位或运算，可以讲浮点型强制转换成整型</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">2</span>^<span class="number">53</span>         <span class="comment">--&gt; 9.007199254741e+15 (浮点型值)</span></span><br><span class="line">&gt;<span class="number">2</span>^<span class="number">53</span> | <span class="number">0</span>     <span class="comment">--&gt; 9007199254740992 (整型值)</span></span><br></pre></td></tr></table></figure>
<p>练习：<br>练习3.1：以下哪些是有效的数值常量？它们的值分别是多少？</p>
<img src="/blog/p/6fbb57c1/3.9%E7%BB%83%E4%B9%A0-%E6%9C%89%E6%95%88%E6%95%B0%E5%80%BC1.png" class="" title="3.9练习-有效数值1.png">

<p>练习3.2：解释下列表达式之所以得出相应结果的原因。（注意：整型算术运算总是会回环。）</p>
<img src="/blog/p/6fbb57c1/3.9%E7%BB%83%E4%B9%A0-%E6%9C%89%E6%95%88%E6%95%B0%E5%80%BC2.png" class="" title="3.9练习-有效数值2.png">

<p>练习3.3：下列代码的输出结果是什么？</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i = <span class="number">-10</span>, <span class="number">10</span> <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(i, i%<span class="number">3</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<img src="/blog/p/6fbb57c1/3.9%E7%BB%83%E4%B9%A0-%E6%9C%89%E6%95%88%E6%95%B0%E5%80%BC3.png" class="" title="3.9练习-有效数值3.png">

<h2 id="3-7-运算符优先级"><a href="#3-7-运算符优先级" class="headerlink" title="3.7 运算符优先级"></a>3.7 运算符优先级</h2><p>TODO</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="33-线程和状态"><a href="#33-线程和状态" class="headerlink" title="33 线程和状态"></a>33 线程和状态</h2><p>多线程：共享内存(重点1)的抢占式线程(重点2)</p>
<p><code>Lua协程</code> 本质就是<code>线程(thread)</code></p>
<p>lua_pushnumber时 lua_State这些函数的第一个参数，不仅表示的lua状态</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure></div></article></div></main><footer><div class="paginator"><a href="/blog/p/c8a4b253/" class="prev">上一篇</a><a href="/blog/p/5001f0a0/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'seansun';
var disqus_identifier = 'p/6fbb57c1/';
var disqus_title = 'Lua';
var disqus_url = 'https://ayou129.github.io/blog/p/6fbb57c1/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//seansun.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2022 <a href="https://ayou129.github.io/blog">阿尤</a>.</p><!--p © #{year} #[a(href=config.url)!= config.author], powered by #[a(href=hexoURL, target="_blank") Hexo] and #[a(href=apolloURL, target="_blank") hexo-theme-apollo].--></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>