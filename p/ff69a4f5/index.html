<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 微信抢红包算法 · 阿尤</title><meta name="description" content="微信抢红包算法 - 阿尤"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/blog/index.ico"><link rel="stylesheet" href="/blog/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://ayou129.github.io/blog/atom.xml" title="阿尤"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="阿尤" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/blog/" class="logo-link"><img src="/blog/index.ico" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/blog/" target="_self" class="nav-list-link">首页</a></li><li class="nav-list-item"><a href="/blog/archives/" target="_self" class="nav-list-link">历史文章</a></li><li class="nav-list-item"><a href="/blog/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><!--mixin postList()--><!--    .archive--><!--        - var year = 0;--><!--        - var change = false;--><!--        - page.posts.each(function (item) {--><!--            - var itemYear = date(item.date, 'YYYY') - 0;--><!--            - change = year !== itemYear;--><!--            - year = change ? itemYear : year;--><!--            if change--><!--                h2.archive-year!= year--><!--            .post-item--><!--                +postInfo(item)--><!--                a.post-title-link(href= url_for(item.path))--><!--                    != item.title--><!--        - })--><div class="post"><article class="post-block"><h1 class="post-title">微信抢红包算法</h1><div class="post-info">创建于：2020年3月1日<span style="margin-left: 0.5rem"></span>上次更新：2022年10月23日</div><div class="post-content"><p>红包是我做过最有成就感的一个功能🤗，上线之后也优化了一些bug，整体满意度90%，下面介绍一下详情：</p>
<span id="more"></span>

<h2 id="红包算法"><a href="#红包算法" class="headerlink" title="红包算法"></a>红包算法</h2><ul>
<li><a href="https://www.cnblogs.com/dreign/p/4610766.html" target="_blank" rel="noopener">https://www.cnblogs.com/dreign/p/4610766.html</a></li>
</ul>
<p>正态分布运算逻辑：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#红包总金额</span></span><br><span class="line"><span class="meta">#红包个数</span></span><br><span class="line"><span class="meta">#能够领取的红包金额 = 剩余红包金额/剩余红包个数*2</span></span><br><span class="line"><span class="meta">#防止极端情况，每次都是0.01或者20元，用代码解决</span></span><br><span class="line"><span class="meta">#最后设置重入机制</span></span><br><span class="line"><span class="meta">#执行完后放入redis的list</span></span><br><span class="line"><span class="meta">#生成红包信息时记录到mysql</span></span><br><span class="line"><span class="meta">#抢红包时异步记录到mysql</span></span><br></pre></td></tr></table></figure>
<h2 id="红包的类型"><a href="#红包的类型" class="headerlink" title="红包的类型"></a>红包的类型</h2><h3 id="拼手气红包，只能在群组中发送"><a href="#拼手气红包，只能在群组中发送" class="headerlink" title="拼手气红包，只能在群组中发送"></a>拼手气红包，只能在群组中发送</h3><p>用户输入的参数：总金额、红包个数<br>系统算出的参数：单个红包的金额(随机的，有大有小)</p>
<div style="width:50%;margin:0 auto;">
<img src="/blog/p/ff69a4f5/%E6%8B%BC%E6%89%8B%E6%B0%94%E7%BA%A2%E5%8C%85.png" class="" title="拼手气红包.png">
</div>

<h3 id="普通红包"><a href="#普通红包" class="headerlink" title="普通红包"></a>普通红包</h3><p>用户输入的参数：单个红包的金额、红包个数<br>系统算出的参数：总金额</p>
<div style="width:50%;margin:0 auto;">
<img src="/blog/p/ff69a4f5/%E6%99%AE%E9%80%9A%E7%BA%A2%E5%8C%85.png" class="" title="普通红包.png">
</div>

<h3 id="整体上"><a href="#整体上" class="headerlink" title="整体上"></a>整体上</h3><ol>
<li>拼手气红包：<code>总金额(用户填写)</code> &#x3D; <code>单个红包的金额(缺省)</code> * <code>红包个数(用户填写)</code></li>
<li>普通红包：<code>总金额(缺省)</code> &#x3D; <code>单个红包的金额(用户填写)</code> * <code>红包个数(用户填写)</code></li>
</ol>
<h2 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h2><p>所有问题：</p>
<ul>
<li>数据一致性</li>
<li>性能</li>
</ul>
<p>出现的问题：</p>
<ol>
<li>高并发场景执行程序，会发现超发现象</li>
</ol>
<p>实现思路：</p>
<ol>
<li>如果使用 <code>mysql数据表</code> 以及使用 <code>事务</code> 实现，会发生超发红包的情况</li>
<li>如果在mysql中使用了 <code>悲观锁</code>  则严重影响性能，甚至宕机 <code>mysql Too many connections</code></li>
<li>如果使用 <code>CAS机制(version)</code> 实现，则会出现 <code>ABA</code> 的问题，就算利用 <code>重发机制</code> 完善 <code>ABA</code>，对于性能还是有较高的要求</li>
</ol>
<p>综上所述，最优解决方案可以通过redis缓存机制以及redis原子性解决上述问题</p>
<h3 id="第一个版本-Mysql数据表实现"><a href="#第一个版本-Mysql数据表实现" class="headerlink" title="第一个版本 Mysql数据表实现"></a>第一个版本 Mysql数据表实现</h3><h4 id="数据表"><a href="#数据表" class="headerlink" title="数据表"></a>数据表</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#红包表</span><br><span class="line">DROP TABLE IF EXISTS `red_envelopes`;</span><br><span class="line">CREATE TABLE `red_envelopes`</span><br><span class="line">(</span><br><span class="line">    `id`            INT(11)                   NOT NULL AUTO_INCREMENT,</span><br><span class="line">    `user_id`       INT(11)                   NOT NULL,</span><br><span class="line">    `total_amount`  decimal(6, 2)             NOT NULL COMMENT &#x27;红包总金额&#x27;,</span><br><span class="line">    `single_amount` decimal(6, 2) DEFAULT 0 COMMENT &#x27;单个红包金额&#x27;,</span><br><span class="line">    `number`        INT(11)                   NOT NULL COMMENT &#x27;红包个数&#x27;,</span><br><span class="line">    `type`          enum (&#x27;ordinary&#x27;,&#x27;lucky&#x27;) NOT NULL COMMENT &#x27;红包类型&#x27;,</span><br><span class="line">    `note`          varchar(255)  DEFAULT &#x27;&#x27; COMMENT &#x27;红包备注&#x27;,</span><br><span class="line">    `create_time`   INT(11)       DEFAULT NULL COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">    `update_time`   INT(11)       DEFAULT NULL COMMENT &#x27;更新时间&#x27;,</span><br><span class="line">    `delete_time`   INT(11)       DEFAULT NULL COMMENT &#x27;删除时间&#x27;,</span><br><span class="line">    PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE = INNODB;</span><br><span class="line"></span><br><span class="line">#抢红包信息</span><br><span class="line">DROP TABLE IF EXISTS `red_envelopes_log`;</span><br><span class="line">CREATE TABLE `red_envelopes_log`</span><br><span class="line">(</span><br><span class="line">    `id`               INT(11)       NOT NULL AUTO_INCREMENT,</span><br><span class="line">    `red_envelopes_id` INT(11)       NOT NULL COMMENT &#x27;红包ID&#x27;,</span><br><span class="line">    `user_id`          INT(11)       NOT NULL COMMENT &#x27;抢红包的用户ID&#x27;,</span><br><span class="line">    `rob_amount`       decimal(6, 2) NOT NULL COMMENT &#x27;抢到的红包金额&#x27;,</span><br><span class="line">    `create_time`      INT(11) DEFAULT NULL COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">    `update_time`      INT(11) DEFAULT NULL COMMENT &#x27;更新时间&#x27;,</span><br><span class="line">    `delete_time`      INT(11) DEFAULT NULL COMMENT &#x27;删除时间&#x27;,</span><br><span class="line">    PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE = INNODB;</span><br></pre></td></tr></table></figure>

<h4 id="php红包控制器类"><a href="#php红包控制器类" class="headerlink" title="php红包控制器类"></a>php红包控制器类</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">api</span>\<span class="title">controller</span>\<span class="title">v1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">api</span>\<span class="title">service</span>\<span class="title">LuckyRedEnvelope</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Db</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">response</span>\<span class="title">Json</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> <span class="keyword">extends</span> <span class="title">V1BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Json</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">job</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Db::startTrans();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            (<span class="keyword">new</span> LuckyRedEnvelope())-&gt;rob(<span class="number">1</span>, <span class="string">&#x27;10000&#x27;</span>);</span><br><span class="line"></span><br><span class="line">            Db::commit();</span><br><span class="line">            <span class="keyword">return</span> json([<span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;您抢到了红包&#x27;</span>]);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">            Db::rollback();</span><br><span class="line">            <span class="keyword">throw</span> <span class="variable">$e</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="php红包service类"><a href="#php红包service类" class="headerlink" title="php红包service类"></a>php红包service类</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">api</span>\<span class="title">service</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">api</span>\<span class="title">model</span>\<span class="title">RedEnvelopesLog</span> <span class="title">as</span> <span class="title">RedEnvelopesLogModel</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">api</span>\<span class="title">model</span>\<span class="title">RedEnvelopes</span> <span class="title">as</span> <span class="title">RedEnvelopesModel</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">exception</span>\<span class="title">ParameterException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">db</span>\<span class="title">exception</span>\<span class="title">DataNotFoundException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">db</span>\<span class="title">exception</span>\<span class="title">ModelNotFoundException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">exception</span>\<span class="title">DbException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拼手气红包</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@package</span> app\api\service</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LuckyRedEnvelope</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> TYPE                    = <span class="string">&#x27;lucky&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> MIN_RED_ENVELOPE_AMOUNT = <span class="number">0.01</span>; <span class="comment">#红包最小值</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$redEnvelopesModel</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$remainderAmount</span> = <span class="number">0</span>;<span class="comment">#剩余红包总金额</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$remainderNumber</span> = <span class="number">0</span>;<span class="comment">#剩余红包个数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建红包</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $total_amount</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $number</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">generate</span>(<span class="params"><span class="variable">$total_amount</span>, <span class="variable">$number</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$total_amount</span> = filter_var(<span class="variable">$total_amount</span>, FILTER_VALIDATE_INT);</span><br><span class="line">        <span class="variable">$number</span>       = filter_var(<span class="variable">$number</span>, FILTER_VALIDATE_INT);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$total_amount</span> === <span class="literal">false</span> || <span class="variable">$number</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParameterException([<span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;红包参数错误&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//总金额(用户填写) = 单个红包的金额(缺省) * 红包个数(用户填写)</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$total_amount</span> &lt; <span class="number">0.01</span> * <span class="variable">$number</span> || <span class="variable">$total_amount</span> &gt; <span class="number">200000</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParameterException([<span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;红包参数错误&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$preSaveData</span> = [</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>      =&gt; <span class="string">&#x27;10000&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;total_amount&#x27;</span> =&gt; <span class="variable">$total_amount</span>,</span><br><span class="line">            <span class="string">&#x27;number&#x27;</span>       =&gt; <span class="variable">$number</span>,</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>         =&gt; <span class="built_in">self</span>::TYPE,</span><br><span class="line">        ];</span><br><span class="line">        <span class="variable">$status</span>      = (<span class="keyword">new</span> RedEnvelopesModel())-&gt;save(<span class="variable">$preSaveData</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$status</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检查库存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $red_envelopes_id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $user_id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> DataNotFoundException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> DbException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ModelNotFoundException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ParameterException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkStock</span>(<span class="params"><span class="variable">$red_envelopes_id</span>, <span class="variable">$user_id</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$redEnvelopesModel</span> = RedEnvelopesModel::where(<span class="string">&#x27;id&#x27;</span>, <span class="variable">$red_envelopes_id</span>)</span><br><span class="line">            -&gt;where(<span class="string">&#x27;user_id&#x27;</span>, <span class="variable">$user_id</span>)</span><br><span class="line">            -&gt;where(<span class="string">&#x27;type&#x27;</span>, <span class="built_in">self</span>::TYPE)</span><br><span class="line">            -&gt;with([<span class="string">&#x27;robLog&#x27;</span>])</span><br><span class="line">            -&gt;find();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$redEnvelopesModel</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParameterException([<span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;该红包不存在&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$redEnvelopesArray</span>       = <span class="variable">$redEnvelopesModel</span>-&gt;toArray();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;redEnvelopesModel = <span class="variable">$redEnvelopesModel</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;remainderAmount   = <span class="variable">$redEnvelopesArray</span>[<span class="string">&#x27;total_amount&#x27;</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;remainderNumber   = <span class="variable">$redEnvelopesArray</span>[<span class="string">&#x27;number&#x27;</span>];</span><br><span class="line">        <span class="variable">$redEnvelopesLogArray</span>    = <span class="variable">$redEnvelopesArray</span>[<span class="string">&#x27;rob_log&#x27;</span>]-&gt;toArray();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$redEnvelopesLogArray</span> <span class="keyword">as</span> <span class="variable">$item</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;remainderNumber--;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;remainderAmount = bcsub(<span class="keyword">$this</span>-&gt;remainderAmount, <span class="variable">$item</span>[<span class="string">&#x27;rob_amount&#x27;</span>], <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;remainderAmount &gt; <span class="number">0</span> &amp;&amp; <span class="keyword">$this</span>-&gt;remainderNumber &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 抢红包 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $red_envelopes_id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $user_id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> DataNotFoundException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> DbException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ModelNotFoundException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ParameterException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rob</span>(<span class="params"><span class="variable">$red_envelopes_id</span>, <span class="variable">$user_id</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$stockStatus</span> = <span class="keyword">$this</span>-&gt;checkStock(<span class="variable">$red_envelopes_id</span>, <span class="variable">$user_id</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$stockStatus</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParameterException([<span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;库存不足&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//平均期望值 * 2</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;remainderNumber === <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="variable">$money</span> = <span class="keyword">$this</span>-&gt;remainderAmount;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$money</span> = mt_rand(<span class="built_in">self</span>::MIN_RED_ENVELOPE_AMOUNT * <span class="number">100</span>,</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;remainderAmount / <span class="keyword">$this</span>-&gt;remainderNumber * <span class="number">2</span> * <span class="number">100</span>) / <span class="number">100</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$money</span> = <span class="variable">$money</span> &lt; <span class="built_in">self</span>::MIN_RED_ENVELOPE_AMOUNT ? <span class="built_in">self</span>::MIN_RED_ENVELOPE_AMOUNT : <span class="variable">$money</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//存入红包日志表</span></span><br><span class="line">        <span class="variable">$redEnvelopesLogModel</span>                   = <span class="keyword">new</span> RedEnvelopesLogModel();</span><br><span class="line">        <span class="variable">$redEnvelopesLogModel</span>-&gt;red_envelopes_id = <span class="variable">$red_envelopes_id</span>;</span><br><span class="line">        <span class="variable">$redEnvelopesLogModel</span>-&gt;user_id          = <span class="variable">$user_id</span>;</span><br><span class="line">        <span class="variable">$redEnvelopesLogModel</span>-&gt;rob_amount       = <span class="variable">$money</span>;</span><br><span class="line">        <span class="variable">$redEnvelopesLogModel</span>-&gt;save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Redis实现"><a href="#Redis实现" class="headerlink" title="Redis实现"></a>Redis实现</h3><h4 id="Redis类"><a href="#Redis类" class="headerlink" title="Redis类"></a>Redis类</h4><h3 id="第二个版本-Mysql悲观锁实现-for-update"><a href="#第二个版本-Mysql悲观锁实现-for-update" class="headerlink" title="第二个版本 Mysql悲观锁实现 for update"></a>第二个版本 Mysql悲观锁实现 for update</h3><p>解决超发问题</p>
<p>注意，在 SQL 中加入的 for update 语句，意味着将持有对数据库记录的行更新锁（因为这里使用主键查询，所以只会对行加锁。如果使用的是非主键查询，要考虑是否对全表加锁的问题，加锁后可能引发其他查询的阻塞），那就意味着在高并发的场景下，当一条事务持有了这个更新锁才能往下操作，其他的线程如果要更新这条记录，都需要等待，这样就不会出现超发现象引发的数据一致性问题了。</p>
<p>有性能瓶颈，因为悲观锁的实现方式就是抢锁，当请求过多时，会堵塞进程，造成延迟甚至 bad request</p>
<h3 id="第三个版本-Mysql乐观锁-以及-CAS机制-实现-version"><a href="#第三个版本-Mysql乐观锁-以及-CAS机制-实现-version" class="headerlink" title="第三个版本 Mysql乐观锁 以及 CAS机制 实现(version)"></a>第三个版本 Mysql乐观锁 以及 CAS机制 实现(version)</h3><p>会有ABA的问题</p>
<blockquote>
<p><a href="https://en.wikipedia.org/wiki/ABA_problem" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/ABA_problem</a></p>
</blockquote>
<h3 id="第四个版本-重入机制"><a href="#第四个版本-重入机制" class="headerlink" title="第四个版本 重入机制"></a>第四个版本 重入机制</h3><p>有性能问题</p>
<h3 id="最终版本-Redis实现"><a href="#最终版本-Redis实现" class="headerlink" title="最终版本 Redis实现"></a>最终版本 Redis实现</h3><p>解决的问题：超发(原子性)、性能问题(内存操作，非阻塞Io多路复用机制)、</p>
</div></article></div></main><footer><div class="paginator"><a href="/blog/p/bcbac40b/" class="prev">上一篇</a><a href="/blog/p/f255ffad/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'seansun';
var disqus_identifier = 'p/ff69a4f5/';
var disqus_title = '微信抢红包算法';
var disqus_url = 'https://ayou129.github.io/blog/p/ff69a4f5/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//seansun.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2022 <a href="https://ayou129.github.io/blog">阿尤</a>.</p><!--p © #{year} #[a(href=config.url)!= config.author], powered by #[a(href=hexoURL, target="_blank") Hexo] and #[a(href=apolloURL, target="_blank") hexo-theme-apollo].--></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>