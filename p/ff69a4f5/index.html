<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 实战:微信抢红包算法 · 阿尤</title><meta name="description" content="实战:微信抢红包算法 - 阿尤"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/blog/index.ico"><link rel="stylesheet" href="/blog/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://ayou129.github.io/blog/atom.xml" title="阿尤"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="阿尤" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/blog/" class="logo-link"><img src="/blog/index.ico" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/blog/" target="_self" class="nav-list-link">首页</a></li><li class="nav-list-item"><a href="/blog/archives/" target="_self" class="nav-list-link">历史文章</a></li><li class="nav-list-item"><a href="/blog/tags" target="_self" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="/blog/categories" target="_self" class="nav-list-link">分类</a></li><li class="nav-list-item"><a href="/blog/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><!--mixin postList()--><!--    .archive--><!--        - var year = 0;--><!--        - var change = false;--><!--        - page.posts.each(function (item) {--><!--            - var itemYear = date(item.date, 'YYYY') - 0;--><!--            - change = year !== itemYear;--><!--            - year = change ? itemYear : year;--><!--            if change--><!--                h2.archive-year!= year--><!--            .post-item--><!--                +postInfo(item)--><!--                a.post-title-link(href= url_for(item.path))--><!--                    != item.title--><!--        - })--><div class="post"><article class="post-block"><h1 class="post-title">实战:微信抢红包算法</h1><div class="post-info">创建于：2020年3月1日<span style="margin-left: 0.5rem"></span>上次更新：2022年10月23日</div><div class="post-content"><p>红包是我做过最有成就感的一个功能🤗，上线之后也优化了一些bug，整体满意度90%，下面介绍一下详情：</p>
<span id="more"></span>

<h2 id="功能背景"><a href="#功能背景" class="headerlink" title="功能背景"></a>功能背景</h2><p>公司产品是一款<code>社交性APP</code>，功能中包含用户间、用户与群组间的聊天，用户群体大部分是年轻人，成年-30来岁。</p>
<p>所以诞生了优先级很高的一个产品需求：<code>红包功能</code>，可以提高用户的活跃度。</p>
<h2 id="任务"><a href="#任务" class="headerlink" title="任务"></a>任务</h2><p>与前端<code>Android</code>和<code>IOS</code>同事确认事实方案后，完成产品开发以及测试。</p>
<h2 id="行动"><a href="#行动" class="headerlink" title="行动"></a>行动</h2><p>由于该功能是基于腾讯IM的，所以我阅读了腾讯云相关的功能介绍，并与同事进行了沟通，明确了<code>各自分工</code>、<code>共同制定通话场景的业务文档(红包正常以及错误码标识)</code>、<code>工作优先级</code>、<code>日期规划</code>(完成、提测、正式上线日期)等</p>
<h3 id="个人难点"><a href="#个人难点" class="headerlink" title="个人难点"></a>个人难点</h3><ul>
<li><p><strong>红包采用哪种分配方式？</strong><br>经过不同部门共同探讨决定使用<code>均匀金额</code>的方式，基本原则也就是是：红包分配的钱数满足截尾正态随机数分布。</p>
<ul>
<li>其好处是减少抽取红包大小分布的方差，让更多的人抽取的红包在均值附近，同时仍给一小部分人抽取大红包的机会，总体来说增加了红包抽取人的积极性和游戏的公平性。</li>
<li>每个红包里面的金额是：<code>随机，额度在0.01和(剩余平均值*2)之间，并且保证每个用户最低能拿到1分钱</code>。</li>
<li>先抢后抢拿到红包的大小的期望是大致相等的</li>
<li>后抢的人<code>方差</code>大（依赖前面人抢的多少），波动较大，有较大几率拿到”手气最佳”，例如10个红包，前面的人都抢到了1分钱，最后一个人独揽99元。</li>
</ul>
</li>
<li><p><strong>红包里的金额什么时候算？</strong><br> 我们决策的依据是<code>数据的准确性&gt;性能</code>，所以我们选择了发红包的时候就算出每个红包内的金额，纳入追溯日志当中。</p>
</li>
<li><p><strong>红包发出去是否能够撤回？</strong><br> PM考虑到不同的主体(发红包用户、抢红包用户、未抢到红包用户、平台)之间的权衡，决定不能撤回。 说白了就是宁愿 发送红包的人发错一个人承担 也不要得罪 更多的人。</p>
</li>
<li><p><strong>红包如何设计？</strong></p>
<ul>
<li>发红包时拆分每个红包金额，将每个红包存储到Redis的list中，记录追溯日志</li>
<li>抢红包时，pop按照顺序逐个取出，记录追溯日志</li>
<li>当抢到最后一个红包时，完成后续处理(红包状态，手气最佳，结束该红包的追溯日志)</li>
</ul>
</li>
<li><p><strong>会不会出现多个手气最佳？</strong></p>
<ul>
<li>金额会出现一样的，但是手气最佳只有一个，先抢到就算</li>
</ul>
</li>
<li><p><strong>计算出错怎么办？</strong><br>  有回滚操作</p>
</li>
<li><p><strong>注意事项</strong><br>  红包总金额：<code>100元</code>，总抢的人数：<code>5个</code>，极小概率出现两个极限</p>
<ol>
<li>每个人抢到的都是0.01，那么最后一个人独揽</li>
<li>每个人抢到的都是<code>最大金额</code>，⚠️BUG⚠️！！！下方是详情介绍<table>
<thead>
<tr>
<th>抢红包的顺序</th>
<th>抢红包之前还剩</th>
<th>抢红包之前能拿到金额的范围</th>
<th>抢完之后总红包剩余</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>100</td>
<td>最低0.01 - 最高(100&#x2F;5)*2&#x3D;40</td>
<td>60</td>
</tr>
<tr>
<td>2</td>
<td>60</td>
<td>最低0.01 - 最高(60&#x2F;4)*2&#x3D;30</td>
<td>30</td>
</tr>
<tr>
<td>3</td>
<td>30</td>
<td>最低0.01 - 最高(30&#x2F;3)*2&#x3D;20</td>
<td>10</td>
</tr>
<tr>
<td>4</td>
<td>10</td>
<td>最低0.01 - 最高(10&#x2F;2)*2&#x3D;10</td>
<td>0</td>
</tr>
<tr>
<td>5</td>
<td>0</td>
<td>最低0.01 - 最高(0&#x2F;1)*2&#x3D;10</td>
<td>完蛋，最后一个人没得抢了🥵</td>
</tr>
</tbody></table>
</li>
</ol>
<p>  这种特殊情况最后一个人是拿不到金额的，所以算法中要保证剩余用户能拿到最少1分钱。</p>
<ul>
<li>解决方案：<code>拆红包金额算法</code> 增加 <code>重试功能</code>，最后一人没有金额则尝试重新计算。</li>
<li>如果总金额是5分钱，总数是5个人，那么算法直接取<code>平均值</code>1分钱，不走核心逻辑，提高效率。</li>
</ul>
</li>
</ul>
<h2 id="红包的类型"><a href="#红包的类型" class="headerlink" title="红包的类型"></a>红包的类型</h2><ol>
<li>拼手气红包：<code>总金额(用户填写)</code> &#x3D; <code>单个红包的金额(缺省)</code> * <code>红包个数(用户填写)</code></li>
<li>普通红包：<code>总金额(缺省)</code> &#x3D; <code>单个红包的金额(用户填写)</code> * <code>红包个数(用户填写)</code></li>
</ol>
<h3 id="拼手气红包，只能在群组中发送"><a href="#拼手气红包，只能在群组中发送" class="headerlink" title="拼手气红包，只能在群组中发送"></a>拼手气红包，只能在群组中发送</h3><p>用户输入的参数：总金额、红包个数<br>系统算出的参数：单个红包的金额(随机的，有大有小)</p>
<div style="width:50%;margin:0 auto;">
<img src="/blog/p/ff69a4f5/%E6%8B%BC%E6%89%8B%E6%B0%94%E7%BA%A2%E5%8C%85.png" class="" title="拼手气红包.png">
</div>

<h3 id="普通红包"><a href="#普通红包" class="headerlink" title="普通红包"></a>普通红包</h3><p>用户输入的参数：单个红包的金额、红包个数<br>系统算出的参数：总金额</p>
<div style="width:50%;margin:0 auto;">
<img src="/blog/p/ff69a4f5/%E6%99%AE%E9%80%9A%E7%BA%A2%E5%8C%85.png" class="" title="普通红包.png">
</div>


<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过测试小仙女们的无情测试，提出了一些特殊场景：</p>
<ul>
<li>如上方的两个极限情况</li>
<li>日志追溯功能</li>
</ul>
<p>上线后用户们的活跃度还是有大幅度提升的，我也真正体会到了算法的力量！成就感满满，谢谢大家阅读~</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><blockquote>
<p><a href="https://www.cnblogs.com/dreign/p/4610766.html" target="_blank" rel="noopener">https://www.cnblogs.com/dreign/p/4610766.html</a></p>
</blockquote>
</div></article></div></main><footer><div class="paginator"><a href="/blog/p/bcbac40b/" class="prev">上一篇</a><a href="/blog/p/f255ffad/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'seansun';
var disqus_identifier = 'p/ff69a4f5/';
var disqus_title = '实战:微信抢红包算法';
var disqus_url = 'https://ayou129.github.io/blog/p/ff69a4f5/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//seansun.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2022 <a href="https://ayou129.github.io/blog">阿尤</a>.</p><!--p © #{year} #[a(href=config.url)!= config.author], powered by #[a(href=hexoURL, target="_blank") Hexo] and #[a(href=apolloURL, target="_blank") hexo-theme-apollo].--></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>