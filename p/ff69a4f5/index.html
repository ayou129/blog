<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> å¾®ä¿¡æŠ¢çº¢åŒ…ç®—æ³• Â· é˜¿å°¤</title><meta name="description" content="å¾®ä¿¡æŠ¢çº¢åŒ…ç®—æ³• - é˜¿å°¤"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/blog/index.ico"><link rel="stylesheet" href="/blog/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://ayou129.github.io/blog/atom.xml" title="é˜¿å°¤"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="é˜¿å°¤" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/blog/" class="logo-link"><img src="/blog/index.ico" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/blog/" target="_self" class="nav-list-link">é¦–é¡µ</a></li><li class="nav-list-item"><a href="/blog/archives/" target="_self" class="nav-list-link">å†å²æ–‡ç« </a></li><li class="nav-list-item"><a href="/blog/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><!--mixin postList()--><!--    .archive--><!--        - var year = 0;--><!--        - var change = false;--><!--        - page.posts.each(function (item) {--><!--            - var itemYear = date(item.date, 'YYYY') - 0;--><!--            - change = year !== itemYear;--><!--            - year = change ? itemYear : year;--><!--            if change--><!--                h2.archive-year!= year--><!--            .post-item--><!--                +postInfo(item)--><!--                a.post-title-link(href= url_for(item.path))--><!--                    != item.title--><!--        - })--><div class="post"><article class="post-block"><h1 class="post-title">å¾®ä¿¡æŠ¢çº¢åŒ…ç®—æ³•</h1><div class="post-info">åˆ›å»ºäºï¼š2020å¹´3æœˆ1æ—¥<span style="margin-left: 0.5rem"></span>ä¸Šæ¬¡æ›´æ–°ï¼š2022å¹´10æœˆ23æ—¥</div><div class="post-content"><p>çº¢åŒ…æ˜¯æˆ‘åšè¿‡æœ€æœ‰æˆå°±æ„Ÿçš„ä¸€ä¸ªåŠŸèƒ½ğŸ¤—ï¼Œä¸Šçº¿ä¹‹åä¹Ÿä¼˜åŒ–äº†ä¸€äº›bugï¼Œæ•´ä½“æ»¡æ„åº¦90%ï¼Œä¸‹é¢ä»‹ç»ä¸€ä¸‹è¯¦æƒ…ï¼š</p>
<span id="more"></span>

<h2 id="çº¢åŒ…ç®—æ³•"><a href="#çº¢åŒ…ç®—æ³•" class="headerlink" title="çº¢åŒ…ç®—æ³•"></a>çº¢åŒ…ç®—æ³•</h2><ul>
<li><a href="https://www.cnblogs.com/dreign/p/4610766.html" target="_blank" rel="noopener">https://www.cnblogs.com/dreign/p/4610766.html</a></li>
</ul>
<p>æ­£æ€åˆ†å¸ƒè¿ç®—é€»è¾‘ï¼š</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#çº¢åŒ…æ€»é‡‘é¢</span></span><br><span class="line"><span class="meta">#çº¢åŒ…ä¸ªæ•°</span></span><br><span class="line"><span class="meta">#èƒ½å¤Ÿé¢†å–çš„çº¢åŒ…é‡‘é¢ = å‰©ä½™çº¢åŒ…é‡‘é¢/å‰©ä½™çº¢åŒ…ä¸ªæ•°*2</span></span><br><span class="line"><span class="meta">#é˜²æ­¢æç«¯æƒ…å†µï¼Œæ¯æ¬¡éƒ½æ˜¯0.01æˆ–è€…20å…ƒï¼Œç”¨ä»£ç è§£å†³</span></span><br><span class="line"><span class="meta">#æœ€åè®¾ç½®é‡å…¥æœºåˆ¶</span></span><br><span class="line"><span class="meta">#æ‰§è¡Œå®Œåæ”¾å…¥redisçš„list</span></span><br><span class="line"><span class="meta">#ç”Ÿæˆçº¢åŒ…ä¿¡æ¯æ—¶è®°å½•åˆ°mysql</span></span><br><span class="line"><span class="meta">#æŠ¢çº¢åŒ…æ—¶å¼‚æ­¥è®°å½•åˆ°mysql</span></span><br></pre></td></tr></table></figure>
<h2 id="çº¢åŒ…çš„ç±»å‹"><a href="#çº¢åŒ…çš„ç±»å‹" class="headerlink" title="çº¢åŒ…çš„ç±»å‹"></a>çº¢åŒ…çš„ç±»å‹</h2><h3 id="æ‹¼æ‰‹æ°”çº¢åŒ…ï¼Œåªèƒ½åœ¨ç¾¤ç»„ä¸­å‘é€"><a href="#æ‹¼æ‰‹æ°”çº¢åŒ…ï¼Œåªèƒ½åœ¨ç¾¤ç»„ä¸­å‘é€" class="headerlink" title="æ‹¼æ‰‹æ°”çº¢åŒ…ï¼Œåªèƒ½åœ¨ç¾¤ç»„ä¸­å‘é€"></a>æ‹¼æ‰‹æ°”çº¢åŒ…ï¼Œåªèƒ½åœ¨ç¾¤ç»„ä¸­å‘é€</h3><p>ç”¨æˆ·è¾“å…¥çš„å‚æ•°ï¼šæ€»é‡‘é¢ã€çº¢åŒ…ä¸ªæ•°<br>ç³»ç»Ÿç®—å‡ºçš„å‚æ•°ï¼šå•ä¸ªçº¢åŒ…çš„é‡‘é¢(éšæœºçš„ï¼Œæœ‰å¤§æœ‰å°)</p>
<div style="width:50%;margin:0 auto;">
<img src="/blog/p/ff69a4f5/%E6%8B%BC%E6%89%8B%E6%B0%94%E7%BA%A2%E5%8C%85.png" class="" title="æ‹¼æ‰‹æ°”çº¢åŒ….png">
</div>

<h3 id="æ™®é€šçº¢åŒ…"><a href="#æ™®é€šçº¢åŒ…" class="headerlink" title="æ™®é€šçº¢åŒ…"></a>æ™®é€šçº¢åŒ…</h3><p>ç”¨æˆ·è¾“å…¥çš„å‚æ•°ï¼šå•ä¸ªçº¢åŒ…çš„é‡‘é¢ã€çº¢åŒ…ä¸ªæ•°<br>ç³»ç»Ÿç®—å‡ºçš„å‚æ•°ï¼šæ€»é‡‘é¢</p>
<div style="width:50%;margin:0 auto;">
<img src="/blog/p/ff69a4f5/%E6%99%AE%E9%80%9A%E7%BA%A2%E5%8C%85.png" class="" title="æ™®é€šçº¢åŒ….png">
</div>

<h3 id="æ•´ä½“ä¸Š"><a href="#æ•´ä½“ä¸Š" class="headerlink" title="æ•´ä½“ä¸Š"></a>æ•´ä½“ä¸Š</h3><ol>
<li>æ‹¼æ‰‹æ°”çº¢åŒ…ï¼š<code>æ€»é‡‘é¢(ç”¨æˆ·å¡«å†™)</code> &#x3D; <code>å•ä¸ªçº¢åŒ…çš„é‡‘é¢(ç¼ºçœ)</code> * <code>çº¢åŒ…ä¸ªæ•°(ç”¨æˆ·å¡«å†™)</code></li>
<li>æ™®é€šçº¢åŒ…ï¼š<code>æ€»é‡‘é¢(ç¼ºçœ)</code> &#x3D; <code>å•ä¸ªçº¢åŒ…çš„é‡‘é¢(ç”¨æˆ·å¡«å†™)</code> * <code>çº¢åŒ…ä¸ªæ•°(ç”¨æˆ·å¡«å†™)</code></li>
</ol>
<h2 id="å®ç°æ€è·¯"><a href="#å®ç°æ€è·¯" class="headerlink" title="å®ç°æ€è·¯"></a>å®ç°æ€è·¯</h2><p>æ‰€æœ‰é—®é¢˜ï¼š</p>
<ul>
<li>æ•°æ®ä¸€è‡´æ€§</li>
<li>æ€§èƒ½</li>
</ul>
<p>å‡ºç°çš„é—®é¢˜ï¼š</p>
<ol>
<li>é«˜å¹¶å‘åœºæ™¯æ‰§è¡Œç¨‹åºï¼Œä¼šå‘ç°è¶…å‘ç°è±¡</li>
</ol>
<p>å®ç°æ€è·¯ï¼š</p>
<ol>
<li>å¦‚æœä½¿ç”¨ <code>mysqlæ•°æ®è¡¨</code> ä»¥åŠä½¿ç”¨ <code>äº‹åŠ¡</code> å®ç°ï¼Œä¼šå‘ç”Ÿè¶…å‘çº¢åŒ…çš„æƒ…å†µ</li>
<li>å¦‚æœåœ¨mysqlä¸­ä½¿ç”¨äº† <code>æ‚²è§‚é”</code>  åˆ™ä¸¥é‡å½±å“æ€§èƒ½ï¼Œç”šè‡³å®•æœº <code>mysql Too many connections</code></li>
<li>å¦‚æœä½¿ç”¨ <code>CASæœºåˆ¶(version)</code> å®ç°ï¼Œåˆ™ä¼šå‡ºç° <code>ABA</code> çš„é—®é¢˜ï¼Œå°±ç®—åˆ©ç”¨ <code>é‡å‘æœºåˆ¶</code> å®Œå–„ <code>ABA</code>ï¼Œå¯¹äºæ€§èƒ½è¿˜æ˜¯æœ‰è¾ƒé«˜çš„è¦æ±‚</li>
</ol>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œæœ€ä¼˜è§£å†³æ–¹æ¡ˆå¯ä»¥é€šè¿‡redisç¼“å­˜æœºåˆ¶ä»¥åŠredisåŸå­æ€§è§£å†³ä¸Šè¿°é—®é¢˜</p>
<h3 id="ç¬¬ä¸€ä¸ªç‰ˆæœ¬-Mysqlæ•°æ®è¡¨å®ç°"><a href="#ç¬¬ä¸€ä¸ªç‰ˆæœ¬-Mysqlæ•°æ®è¡¨å®ç°" class="headerlink" title="ç¬¬ä¸€ä¸ªç‰ˆæœ¬ Mysqlæ•°æ®è¡¨å®ç°"></a>ç¬¬ä¸€ä¸ªç‰ˆæœ¬ Mysqlæ•°æ®è¡¨å®ç°</h3><h4 id="æ•°æ®è¡¨"><a href="#æ•°æ®è¡¨" class="headerlink" title="æ•°æ®è¡¨"></a>æ•°æ®è¡¨</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#çº¢åŒ…è¡¨</span><br><span class="line">DROP TABLE IF EXISTS `red_envelopes`;</span><br><span class="line">CREATE TABLE `red_envelopes`</span><br><span class="line">(</span><br><span class="line">    `id`            INT(11)                   NOT NULL AUTO_INCREMENT,</span><br><span class="line">    `user_id`       INT(11)                   NOT NULL,</span><br><span class="line">    `total_amount`  decimal(6, 2)             NOT NULL COMMENT &#x27;çº¢åŒ…æ€»é‡‘é¢&#x27;,</span><br><span class="line">    `single_amount` decimal(6, 2) DEFAULT 0 COMMENT &#x27;å•ä¸ªçº¢åŒ…é‡‘é¢&#x27;,</span><br><span class="line">    `number`        INT(11)                   NOT NULL COMMENT &#x27;çº¢åŒ…ä¸ªæ•°&#x27;,</span><br><span class="line">    `type`          enum (&#x27;ordinary&#x27;,&#x27;lucky&#x27;) NOT NULL COMMENT &#x27;çº¢åŒ…ç±»å‹&#x27;,</span><br><span class="line">    `note`          varchar(255)  DEFAULT &#x27;&#x27; COMMENT &#x27;çº¢åŒ…å¤‡æ³¨&#x27;,</span><br><span class="line">    `create_time`   INT(11)       DEFAULT NULL COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">    `update_time`   INT(11)       DEFAULT NULL COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">    `delete_time`   INT(11)       DEFAULT NULL COMMENT &#x27;åˆ é™¤æ—¶é—´&#x27;,</span><br><span class="line">    PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE = INNODB;</span><br><span class="line"></span><br><span class="line">#æŠ¢çº¢åŒ…ä¿¡æ¯</span><br><span class="line">DROP TABLE IF EXISTS `red_envelopes_log`;</span><br><span class="line">CREATE TABLE `red_envelopes_log`</span><br><span class="line">(</span><br><span class="line">    `id`               INT(11)       NOT NULL AUTO_INCREMENT,</span><br><span class="line">    `red_envelopes_id` INT(11)       NOT NULL COMMENT &#x27;çº¢åŒ…ID&#x27;,</span><br><span class="line">    `user_id`          INT(11)       NOT NULL COMMENT &#x27;æŠ¢çº¢åŒ…çš„ç”¨æˆ·ID&#x27;,</span><br><span class="line">    `rob_amount`       decimal(6, 2) NOT NULL COMMENT &#x27;æŠ¢åˆ°çš„çº¢åŒ…é‡‘é¢&#x27;,</span><br><span class="line">    `create_time`      INT(11) DEFAULT NULL COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">    `update_time`      INT(11) DEFAULT NULL COMMENT &#x27;æ›´æ–°æ—¶é—´&#x27;,</span><br><span class="line">    `delete_time`      INT(11) DEFAULT NULL COMMENT &#x27;åˆ é™¤æ—¶é—´&#x27;,</span><br><span class="line">    PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE = INNODB;</span><br></pre></td></tr></table></figure>

<h4 id="phpçº¢åŒ…æ§åˆ¶å™¨ç±»"><a href="#phpçº¢åŒ…æ§åˆ¶å™¨ç±»" class="headerlink" title="phpçº¢åŒ…æ§åˆ¶å™¨ç±»"></a>phpçº¢åŒ…æ§åˆ¶å™¨ç±»</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">api</span>\<span class="title">controller</span>\<span class="title">v1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">api</span>\<span class="title">service</span>\<span class="title">LuckyRedEnvelope</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Db</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">response</span>\<span class="title">Json</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> <span class="keyword">extends</span> <span class="title">V1BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Json</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">job</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Db::startTrans();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            (<span class="keyword">new</span> LuckyRedEnvelope())-&gt;rob(<span class="number">1</span>, <span class="string">&#x27;10000&#x27;</span>);</span><br><span class="line"></span><br><span class="line">            Db::commit();</span><br><span class="line">            <span class="keyword">return</span> json([<span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;æ‚¨æŠ¢åˆ°äº†çº¢åŒ…&#x27;</span>]);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">            Db::rollback();</span><br><span class="line">            <span class="keyword">throw</span> <span class="variable">$e</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="phpçº¢åŒ…serviceç±»"><a href="#phpçº¢åŒ…serviceç±»" class="headerlink" title="phpçº¢åŒ…serviceç±»"></a>phpçº¢åŒ…serviceç±»</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">api</span>\<span class="title">service</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">api</span>\<span class="title">model</span>\<span class="title">RedEnvelopesLog</span> <span class="title">as</span> <span class="title">RedEnvelopesLogModel</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">api</span>\<span class="title">model</span>\<span class="title">RedEnvelopes</span> <span class="title">as</span> <span class="title">RedEnvelopesModel</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">exception</span>\<span class="title">ParameterException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">db</span>\<span class="title">exception</span>\<span class="title">DataNotFoundException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">db</span>\<span class="title">exception</span>\<span class="title">ModelNotFoundException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">exception</span>\<span class="title">DbException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‹¼æ‰‹æ°”çº¢åŒ…</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@package</span> app\api\service</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LuckyRedEnvelope</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> TYPE                    = <span class="string">&#x27;lucky&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> MIN_RED_ENVELOPE_AMOUNT = <span class="number">0.01</span>; <span class="comment">#çº¢åŒ…æœ€å°å€¼</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$redEnvelopesModel</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$remainderAmount</span> = <span class="number">0</span>;<span class="comment">#å‰©ä½™çº¢åŒ…æ€»é‡‘é¢</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$remainderNumber</span> = <span class="number">0</span>;<span class="comment">#å‰©ä½™çº¢åŒ…ä¸ªæ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºçº¢åŒ…</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $total_amount</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $number</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">generate</span>(<span class="params"><span class="variable">$total_amount</span>, <span class="variable">$number</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$total_amount</span> = filter_var(<span class="variable">$total_amount</span>, FILTER_VALIDATE_INT);</span><br><span class="line">        <span class="variable">$number</span>       = filter_var(<span class="variable">$number</span>, FILTER_VALIDATE_INT);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$total_amount</span> === <span class="literal">false</span> || <span class="variable">$number</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParameterException([<span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;çº¢åŒ…å‚æ•°é”™è¯¯&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ€»é‡‘é¢(ç”¨æˆ·å¡«å†™) = å•ä¸ªçº¢åŒ…çš„é‡‘é¢(ç¼ºçœ) * çº¢åŒ…ä¸ªæ•°(ç”¨æˆ·å¡«å†™)</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$total_amount</span> &lt; <span class="number">0.01</span> * <span class="variable">$number</span> || <span class="variable">$total_amount</span> &gt; <span class="number">200000</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParameterException([<span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;çº¢åŒ…å‚æ•°é”™è¯¯&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$preSaveData</span> = [</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>      =&gt; <span class="string">&#x27;10000&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;total_amount&#x27;</span> =&gt; <span class="variable">$total_amount</span>,</span><br><span class="line">            <span class="string">&#x27;number&#x27;</span>       =&gt; <span class="variable">$number</span>,</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>         =&gt; <span class="built_in">self</span>::TYPE,</span><br><span class="line">        ];</span><br><span class="line">        <span class="variable">$status</span>      = (<span class="keyword">new</span> RedEnvelopesModel())-&gt;save(<span class="variable">$preSaveData</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$status</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ£€æŸ¥åº“å­˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $red_envelopes_id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $user_id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> DataNotFoundException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> DbException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ModelNotFoundException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ParameterException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkStock</span>(<span class="params"><span class="variable">$red_envelopes_id</span>, <span class="variable">$user_id</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$redEnvelopesModel</span> = RedEnvelopesModel::where(<span class="string">&#x27;id&#x27;</span>, <span class="variable">$red_envelopes_id</span>)</span><br><span class="line">            -&gt;where(<span class="string">&#x27;user_id&#x27;</span>, <span class="variable">$user_id</span>)</span><br><span class="line">            -&gt;where(<span class="string">&#x27;type&#x27;</span>, <span class="built_in">self</span>::TYPE)</span><br><span class="line">            -&gt;with([<span class="string">&#x27;robLog&#x27;</span>])</span><br><span class="line">            -&gt;find();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$redEnvelopesModel</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParameterException([<span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;è¯¥çº¢åŒ…ä¸å­˜åœ¨&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$redEnvelopesArray</span>       = <span class="variable">$redEnvelopesModel</span>-&gt;toArray();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;redEnvelopesModel = <span class="variable">$redEnvelopesModel</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;remainderAmount   = <span class="variable">$redEnvelopesArray</span>[<span class="string">&#x27;total_amount&#x27;</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;remainderNumber   = <span class="variable">$redEnvelopesArray</span>[<span class="string">&#x27;number&#x27;</span>];</span><br><span class="line">        <span class="variable">$redEnvelopesLogArray</span>    = <span class="variable">$redEnvelopesArray</span>[<span class="string">&#x27;rob_log&#x27;</span>]-&gt;toArray();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$redEnvelopesLogArray</span> <span class="keyword">as</span> <span class="variable">$item</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;remainderNumber--;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;remainderAmount = bcsub(<span class="keyword">$this</span>-&gt;remainderAmount, <span class="variable">$item</span>[<span class="string">&#x27;rob_amount&#x27;</span>], <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;remainderAmount &gt; <span class="number">0</span> &amp;&amp; <span class="keyword">$this</span>-&gt;remainderNumber &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŠ¢çº¢åŒ… </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $red_envelopes_id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $user_id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> DataNotFoundException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> DbException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ModelNotFoundException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ParameterException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rob</span>(<span class="params"><span class="variable">$red_envelopes_id</span>, <span class="variable">$user_id</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$stockStatus</span> = <span class="keyword">$this</span>-&gt;checkStock(<span class="variable">$red_envelopes_id</span>, <span class="variable">$user_id</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$stockStatus</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParameterException([<span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;åº“å­˜ä¸è¶³&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¹³å‡æœŸæœ›å€¼ * 2</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;remainderNumber === <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="variable">$money</span> = <span class="keyword">$this</span>-&gt;remainderAmount;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$money</span> = mt_rand(<span class="built_in">self</span>::MIN_RED_ENVELOPE_AMOUNT * <span class="number">100</span>,</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;remainderAmount / <span class="keyword">$this</span>-&gt;remainderNumber * <span class="number">2</span> * <span class="number">100</span>) / <span class="number">100</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$money</span> = <span class="variable">$money</span> &lt; <span class="built_in">self</span>::MIN_RED_ENVELOPE_AMOUNT ? <span class="built_in">self</span>::MIN_RED_ENVELOPE_AMOUNT : <span class="variable">$money</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å­˜å…¥çº¢åŒ…æ—¥å¿—è¡¨</span></span><br><span class="line">        <span class="variable">$redEnvelopesLogModel</span>                   = <span class="keyword">new</span> RedEnvelopesLogModel();</span><br><span class="line">        <span class="variable">$redEnvelopesLogModel</span>-&gt;red_envelopes_id = <span class="variable">$red_envelopes_id</span>;</span><br><span class="line">        <span class="variable">$redEnvelopesLogModel</span>-&gt;user_id          = <span class="variable">$user_id</span>;</span><br><span class="line">        <span class="variable">$redEnvelopesLogModel</span>-&gt;rob_amount       = <span class="variable">$money</span>;</span><br><span class="line">        <span class="variable">$redEnvelopesLogModel</span>-&gt;save();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Rediså®ç°"><a href="#Rediså®ç°" class="headerlink" title="Rediså®ç°"></a>Rediså®ç°</h3><h4 id="Redisç±»"><a href="#Redisç±»" class="headerlink" title="Redisç±»"></a>Redisç±»</h4><h3 id="ç¬¬äºŒä¸ªç‰ˆæœ¬-Mysqlæ‚²è§‚é”å®ç°-for-update"><a href="#ç¬¬äºŒä¸ªç‰ˆæœ¬-Mysqlæ‚²è§‚é”å®ç°-for-update" class="headerlink" title="ç¬¬äºŒä¸ªç‰ˆæœ¬ Mysqlæ‚²è§‚é”å®ç° for update"></a>ç¬¬äºŒä¸ªç‰ˆæœ¬ Mysqlæ‚²è§‚é”å®ç° for update</h3><p>è§£å†³è¶…å‘é—®é¢˜</p>
<p>æ³¨æ„ï¼Œåœ¨ SQL ä¸­åŠ å…¥çš„ for update è¯­å¥ï¼Œæ„å‘³ç€å°†æŒæœ‰å¯¹æ•°æ®åº“è®°å½•çš„è¡Œæ›´æ–°é”ï¼ˆå› ä¸ºè¿™é‡Œä½¿ç”¨ä¸»é”®æŸ¥è¯¢ï¼Œæ‰€ä»¥åªä¼šå¯¹è¡ŒåŠ é”ã€‚å¦‚æœä½¿ç”¨çš„æ˜¯éä¸»é”®æŸ¥è¯¢ï¼Œè¦è€ƒè™‘æ˜¯å¦å¯¹å…¨è¡¨åŠ é”çš„é—®é¢˜ï¼ŒåŠ é”åå¯èƒ½å¼•å‘å…¶ä»–æŸ¥è¯¢çš„é˜»å¡ï¼‰ï¼Œé‚£å°±æ„å‘³ç€åœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œå½“ä¸€æ¡äº‹åŠ¡æŒæœ‰äº†è¿™ä¸ªæ›´æ–°é”æ‰èƒ½å¾€ä¸‹æ“ä½œï¼Œå…¶ä»–çš„çº¿ç¨‹å¦‚æœè¦æ›´æ–°è¿™æ¡è®°å½•ï¼Œéƒ½éœ€è¦ç­‰å¾…ï¼Œè¿™æ ·å°±ä¸ä¼šå‡ºç°è¶…å‘ç°è±¡å¼•å‘çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜äº†ã€‚</p>
<p>æœ‰æ€§èƒ½ç“¶é¢ˆï¼Œå› ä¸ºæ‚²è§‚é”çš„å®ç°æ–¹å¼å°±æ˜¯æŠ¢é”ï¼Œå½“è¯·æ±‚è¿‡å¤šæ—¶ï¼Œä¼šå µå¡è¿›ç¨‹ï¼Œé€ æˆå»¶è¿Ÿç”šè‡³ bad request</p>
<h3 id="ç¬¬ä¸‰ä¸ªç‰ˆæœ¬-Mysqlä¹è§‚é”-ä»¥åŠ-CASæœºåˆ¶-å®ç°-version"><a href="#ç¬¬ä¸‰ä¸ªç‰ˆæœ¬-Mysqlä¹è§‚é”-ä»¥åŠ-CASæœºåˆ¶-å®ç°-version" class="headerlink" title="ç¬¬ä¸‰ä¸ªç‰ˆæœ¬ Mysqlä¹è§‚é” ä»¥åŠ CASæœºåˆ¶ å®ç°(version)"></a>ç¬¬ä¸‰ä¸ªç‰ˆæœ¬ Mysqlä¹è§‚é” ä»¥åŠ CASæœºåˆ¶ å®ç°(version)</h3><p>ä¼šæœ‰ABAçš„é—®é¢˜</p>
<blockquote>
<p><a href="https://en.wikipedia.org/wiki/ABA_problem" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/ABA_problem</a></p>
</blockquote>
<h3 id="ç¬¬å››ä¸ªç‰ˆæœ¬-é‡å…¥æœºåˆ¶"><a href="#ç¬¬å››ä¸ªç‰ˆæœ¬-é‡å…¥æœºåˆ¶" class="headerlink" title="ç¬¬å››ä¸ªç‰ˆæœ¬ é‡å…¥æœºåˆ¶"></a>ç¬¬å››ä¸ªç‰ˆæœ¬ é‡å…¥æœºåˆ¶</h3><p>æœ‰æ€§èƒ½é—®é¢˜</p>
<h3 id="æœ€ç»ˆç‰ˆæœ¬-Rediså®ç°"><a href="#æœ€ç»ˆç‰ˆæœ¬-Rediså®ç°" class="headerlink" title="æœ€ç»ˆç‰ˆæœ¬ Rediså®ç°"></a>æœ€ç»ˆç‰ˆæœ¬ Rediså®ç°</h3><p>è§£å†³çš„é—®é¢˜ï¼šè¶…å‘(åŸå­æ€§)ã€æ€§èƒ½é—®é¢˜(å†…å­˜æ“ä½œï¼Œéé˜»å¡Ioå¤šè·¯å¤ç”¨æœºåˆ¶)ã€</p>
</div></article></div></main><footer><div class="paginator"><a href="/blog/p/bcbac40b/" class="prev">ä¸Šä¸€ç¯‡</a><a href="/blog/p/f255ffad/" class="next">ä¸‹ä¸€ç¯‡</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'seansun';
var disqus_identifier = 'p/ff69a4f5/';
var disqus_title = 'å¾®ä¿¡æŠ¢çº¢åŒ…ç®—æ³•';
var disqus_url = 'https://ayou129.github.io/blog/p/ff69a4f5/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//seansun.disqus.com/count.js" async></script><div class="copyright"><p>Â© 2015 - 2022 <a href="https://ayou129.github.io/blog">é˜¿å°¤</a>.</p><!--p Â© #{year} #[a(href=config.url)!= config.author], powered by #[a(href=hexoURL, target="_blank") Hexo] and #[a(href=apolloURL, target="_blank") hexo-theme-apollo].--></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>